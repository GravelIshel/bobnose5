<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BobnoseWiki</title>

<style>
body{margin:0;font-family:Arial;background:#f6f6f6}
.topbar{background:#fff;border-bottom:1px solid #a2a9b1;padding:10px;display:flex;gap:12px;align-items:center}
.logo img{height:36px}
.search{flex:1}
.search input{width:100%;padding:6px}
.layout{display:flex}
.sidebar{width:220px;background:#f8f9fa;border-right:1px solid #a2a9b1;padding:12px;height:100vh;overflow:auto}
.link{color:#0645ad;cursor:pointer;display:block;margin:5px 0}
.category{font-size:12px;color:#333;margin-left:10px}
.content{padding:20px;max-width:900px}
.tabs span{margin-right:12px;color:#0645ad;cursor:pointer}
.tabs span.active{font-weight:bold}
#loginOverlay{position:fixed;inset:0;background:#000000cc;display:flex;align-items:center;justify-content:center}
.loginBox{background:#fff;padding:20px;border:2px solid #000;width:280px;text-align:center}
textarea{width:100%;height:160px}
button{padding:6px 12px;margin-top:8px}
.historyItem{font-size:13px;border-bottom:1px solid #ccc;padding:4px}
</style>
</head>

<body>

<div id="loginOverlay">
  <div class="loginBox">
    <h2>BobnoseWiki Login</h2>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Enter</button>
    <p id="error" style="color:red"></p>
  </div>
</div>

<div class="topbar">
  <div class="logo"><img src="logo.png"></div>
  <div class="search">
    <input id="searchBox" placeholder="Search..." 
           oninput="renderSidebar(searchBox.value)">
  </div>
</div>

<div class="layout">
  <div class="sidebar" id="sidebar"></div>

  <div class="content">

    <div class="tabs">
      <span onclick="showTab('read')" id="tabRead">Read</span>
      <span onclick="showTab('edit')" id="tabEdit">Edit</span>
      <span onclick="showTab('history')" id="tabHistory">History</span>
    </div>

    <div id="readView"></div>

    <div id="editView" style="display:none">
      <input id="editTitle" placeholder="Title"><br><br>
      <input id="editCategory" placeholder="Category"><br><br>
      <textarea id="editContent"></textarea><br>
      <button onclick="saveArticle()">Save</button>
    </div>

    <div id="historyView" style="display:none"></div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1ZZ7ah1JXQ4lHt1JwGzlGhNib8N2auyc",
  authDomain: "bobnose-da095.firebaseapp.com",
  databaseURL: "https://bobnose-da095-default-rtdb.firebaseio.com",
  projectId: "bobnose-da095",
  storageBucket: "bobnose-da095.appspot.com",
  messagingSenderId: "374534708519",
  appId: "1:374534708519:web:63722974df58ea61e4dd02"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const wikiRef = ref(db, "pages");

const PASSWORD = "Mavik";

let pages = {
  "Main Page": {
    category:"General",
    content:"Welcome to BobnoseWiki. Visit [[Projects]].",
    history:[]
  },
  "Projects": {
    category:"Development",
    content:"Game projects and tools.",
    history:[]
  }
};

let current = "Main Page";

/* ---------- FIREBASE LIVE SYNC ---------- */
onValue(wikiRef, snap => {
  if (snap.exists()) pages = snap.val();
  renderSidebar();
  loadPage(current);
});

/* ---------- LOGIN ---------- */
window.login = () => {
  if (password.value === PASSWORD) {
    loginOverlay.style.display = "none";
    renderSidebar();
    loadPage(current);
  } else {
    error.innerText = "Wrong password";
  }
};

/* ---------- SAVE ---------- */
function saveCloud(){
  set(wikiRef, pages);
}

/* ---------- SIDEBAR ---------- */
window.renderSidebar = (filter="") => {
  sidebar.innerHTML = "<b>Pages</b> <button onclick='createNewPage()'>+ New Page</button><hr>";

  Object.keys(pages)
    .filter(p => p.toLowerCase().includes(filter.toLowerCase()))
    .forEach(p => {
      let s = document.createElement("span");
      s.className = "link";
      s.textContent = p;
      s.onclick = () => loadPage(p);

      let c = document.createElement("div");
      c.className = "category";
      c.textContent = pages[p].category;

      sidebar.appendChild(s);
      sidebar.appendChild(c);
  });
};

/* ---------- CREATE NEW PAGE ---------- */
window.createNewPage = () => {
  const title = prompt("Enter new page title:");
  if(!title) return;

  if(pages[title]){
    alert("Page already exists!");
    loadPage(title);
    return;
  }

  pages[title] = {
    category: "Unsorted",
    content: "Write your new article here.",
    history: []
  };

  saveCloud();    // save to Firebase globally
  renderSidebar();
  loadPage(title);
};

/* ---------- LINK PARSER ---------- */
function parseLinks(t){
  return t.replace(/\[\[(.*?)\]\]/g,
    (_,p)=>`<span class="link" onclick="loadPage('${p}')">${p}</span>`);
}

/* ---------- LOAD PAGE ---------- */
window.loadPage = (title) => {

  if(!pages[title]){
    pages[title]={
      category:"Unsorted",
      content:"Write your new article here.",
      history:[]
    };
    saveCloud();
  }

  current = title;

  readView.innerHTML = `
    <h1>${title}</h1>
    <p>${parseLinks(pages[title].content)}</p>
    <i>Category: ${pages[title].category}</i>
  `;

  editTitle.value = title;
  editContent.value = pages[title].content;
  editCategory.value = pages[title].category;

  renderHistory();
  showTab("read");
};

/* ---------- SAVE ARTICLE ---------- */
window.saveArticle = () => {

  pages[current].history.push({
    time: new Date().toLocaleString(),
    content: pages[current].content
  });

  const newTitle = editTitle.value.trim();

  pages[current].content = editContent.value;
  pages[current].category = editCategory.value;

  if(newTitle !== current){
    pages[newTitle] = pages[current];
    delete pages[current];
    current = newTitle;
  }

  saveCloud();
  renderSidebar();
  loadPage(current);
};

/* ---------- HISTORY ---------- */
function renderHistory(){
  historyView.innerHTML = "";
  pages[current].history.slice().reverse().forEach(h=>{
    let d=document.createElement("div");
    d.className="historyItem";
    d.textContent=h.time;
    historyView.appendChild(d);
  });
}

/* ---------- TABS ---------- */
window.showTab = (t) => {
  readView.style.display = t==="read"?"block":"none";
  editView.style.display = t==="edit"?"block":"none";
  historyView.style.display = t==="history"?"block":"none";

  ["Read","Edit","History"].forEach(x =>
    document.getElementById("tab"+x).classList.remove("active")
  );

  document.getElementById(
    "tab"+t.charAt(0).toUpperCase()+t.slice(1)
  ).classList.add("active");
};
</script>

</body>
</html>
